#!/bin/sh

CRATE_TYPE=$1
CRATE_NAME=$2
MAIN_SRC=$3
shift
shift
ALL_SRC=$@

if [ "${CRATE_TYPE}" == "BIN" ]; then
    echo "debug: \$(DEBUG_${CRATE_NAME})"
    echo "release: \$(RELEASE_${CRATE_NAME})"
fi
echo "test: run-test-${CRATE_NAME}"

echo ".PHONY: debug-${CRATE_NAME} release-${CRATE_NAME} test-${CRATE_NAME} run-test-${CRATE_NAME}"
echo "debug-${CRATE_NAME}: \$(DEBUG_${CRATE_NAME})"
echo "release-${CRATE_NAME}: \$(RELEASE_${CRATE_NAME})"
echo "test-${CRATE_NAME}: \$(TEST_${CRATE_NAME})"
echo "run-test-${CRATE_NAME}: \$(TEST_${CRATE_NAME})"
echo "	\$(call RUN_TEST,$<)"

sed -n -e '/extra/!s| *extern  *mod  *\(.*\) *;$|\1|p' ${ALL_SRC} | while read DEP_NAME; do
    echo "\$(DEBUG_${CRATE_NAME}): \$(DEBUG_${DEP_NAME})"
    echo "\$(RELEASE_${CRATE_NAME}): \$(RELEASE_${DEP_NAME})"
    echo "\$(TEST_${CRATE_NAME}): \$(TEST_${DEP_NAME})"
done

echo "\$(DEBUG_${CRATE_NAME}): ${ALL_SRC}"
echo "	\$(call DEBUG_${CRATE_TYPE},$<)"
echo "\$(RELEASE_${CRATE_NAME}): ${ALL_SRC}"
echo "	\$(call RELEASE_${CRATE_TYPE},$<)"
echo "\$(TEST_${CRATE_NAME}): ${ALL_SRC}"
echo "	\$(call TEST_BIN,$<)"
